<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firm Logistics Manager</title>
    
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --white: #ffffff; --danger: #ef4444; --warning: #f59e0b; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        .container { max-width: 1000px; margin: 0 auto; display: none; }
        
        /* Login Overlay */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f3f4f6; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 300px; text-align: center; }
        .login-box input { width: 90%; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .login-box button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: #ddd; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .tab.active { background: var(--primary); color: var(--white); }
        
        /* Forms */
        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; } 
        
        .hidden-field { display: none !important; }

        label { font-size: 0.85rem; color: #555; margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        button.submit-btn { background: #10b981; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 20px; width: 100%; }
        button.submit-btn.updating { background: var(--warning); color: black; } 

        /* Table */
        .table-controls { display: flex; justify-content: space-between; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; }
        tr:hover { background: #f1f5f9; }
        
        .action-btn { padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer; color: white; margin-right: 5px; font-size: 0.8rem; }
        .btn-edit { background: var(--warning); color: black; }
        .btn-delete { background: var(--danger); }

        @media (max-width: 600px) { .table-controls { flex-direction: column; gap: 10px; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>System Login</h2>
        <input type="text" id="username" placeholder="Username (admin/staff)">
        <input type="password" id="password" placeholder="Password">
        <button onclick="attemptLogin()">Login</button>
        <p id="login-error" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
    </div>
</div>

<div class="container" id="app-container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Logistics Management</h2>
        <div style="text-align:right;">
             <button onclick="logout()" style="background:#eee; border:none; padding:5px 10px; cursor:pointer;">Logout</button>
             <button onclick="forceRefreshCustomers()" style="background:#eee; border:none; padding:5px 10px; cursor:pointer; font-size:0.8rem;">üîÑ Sync Customers</button>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="setMode('PURCHASE')">PURCHASE</button>
        <button class="tab" onclick="setMode('SALES')">SALES</button>
        <button class="tab" onclick="setMode('PURCHASE_RET')">PURCHASE RETURN</button>
        <button class="tab" onclick="setMode('SALES_RET')">SALES RETURN</button>
    </div>

    <div class="card">
        <h3 id="form-title">New Entry</h3>
        <p id="edit-notice" style="display:none; color: var(--warning); font-size: 0.9rem;">‚ö†Ô∏è You are editing an existing record. <button type="button" onclick="cancelEdit()" style="text-decoration:underline; border:none; background:none; cursor:pointer; color:blue;">Cancel</button></p>
        
        <form id="logForm" onsubmit="submitData(event)">
            <div class="form-grid" id="dynamic-fields"></div>
            <button type="submit" class="submit-btn" id="save-btn">Save Entry</button>
        </form>
    </div>

    <div class="card">
        <div class="table-controls">
            <h3>Recent Logs</h3>
            <input type="text" id="searchInput" placeholder="Search Bill No, Firm, Name..." onkeyup="renderTable()">
        </div>
        <div style="overflow-x:auto;">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Firm</th>
                        <th>Party/Brand</th>
                        <th>Bill No</th>
                        <th>Pcs</th>
                        <th>Amt</th>
                        <th id="actions-header" style="display:none;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    // --- IMPORT FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- PASTE YOUR FIREBASE CONFIG HERE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBBszqQlych7F1g82TA37y6Bvhj6EwFfdg",
        authDomain: "logistics-app-mona-rnc.firebaseapp.com",
        projectId: "logistics-app-mona-rnc",
        storageBucket: "logistics-app-mona-rnc.firebasestorage.app",
        messagingSenderId: "989428986519",
        appId: "1:989428986519:web:cdcea9bd1b6aecdb9d2fd2",
        measurementId: "G-LSP2HCVPKC"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DATA LISTS ---
    const DATA = {
        firms: ["Mona", "RNC"],
        brands: ["Jockey", "Amante", "Sweet Dreams"],
        employees: ["Damu", "Madam", "Mayur"],
        deliveryTypes: ["Intra-city", "Inter-city"]
    };

    // --- CUSTOMER CACHE LOGIC ---
    let CUSTOMER_DB = [];

    async function loadCustomers() {
        const cached = localStorage.getItem('customer_db');
        if (cached) {
            CUSTOMER_DB = JSON.parse(cached);
            console.log("Loaded customers from cache.");
        } 
        if (CUSTOMER_DB.length === 0) {
            await fetchCustomersFromCloud();
        }
        // --- NEW LOGIC: POPULATE SELLERS LIST ---
        // Filter for anyone with location "SUNDRY CREDITORS"
        const sundrySellers = CUSTOMER_DB
            .filter(c => c.location.toUpperCase() === "SUNDRY CREDITORS")
            .map(c => c.name);
        
        // Update the DATA object
        DATA.sellers = [...sundrySellers].sort();

        // IMPORTANT: Update the Form Configuration so the dropdown sees the new names
        const purchaseField = FORMS.PURCHASE.find(f => f.key === 'party');
        if (purchaseField) {
            purchaseField.options = DATA.sellers;
        }

        console.log(`Added ${sundrySellers.length} Sundry Creditors to the Purchase list.`);
    }

    async function fetchCustomersFromCloud() {
        console.log("Downloading customers from cloud...");
        const q = query(collection(db, "customers"));
        const snap = await getDocs(q);
        
        CUSTOMER_DB = [];
        snap.forEach(doc => {
            const d = doc.data();
            CUSTOMER_DB.push({ name: d.name, location: d.location });
        });

        localStorage.setItem('customer_db', JSON.stringify(CUSTOMER_DB));
        alert(`Synced ${CUSTOMER_DB.length} customers from cloud!`);
    }
    window.forceRefreshCustomers = () => fetchCustomersFromCloud();

    // --- FORM CONFIGURATION ---
    const FORMS = {
        PURCHASE: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "L/R Date", type: "date", key: "date_lr" },
            { label: "L/R No.", type: "text", key: "L/R_no" },
            { label: "Bill Date", type: "date", key: "date_bill" },
            { label: "Bill No.", type: "text", key: "bill_no" },
            { label: "Date Recd", type: "date", key: "date_recd" },
            { label: "Seller Name", type: "text", key: "party", list: "purchase_sellers" },
            { label: "Cartons", type: "number", key: "cartons" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Recd By", type: "select", options: DATA.employees, key: "recd_by" },
            { label: "Checked By", type: "select", options: DATA.employees, key: "checked_by" },
            { label: "Remark", type: "text", key: "remark" }
        ],
        SALES: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "Bill Date", type: "date", key: "date_bill" },
            { label: "Delivery Date", type: "date", key: "date_deliv" },
            
            // --- NEW INTERACTIVE FIELDS ---
            { label: "Location (Filter)", type: "text", key: "location_filter", list: "locations" },
            { label: "Purchaser/Cust", type: "text", key: "party", list: "customers" },
            // ------------------------------

            { label: "Brand", type: "select", options: DATA.brands, key: "brand" },
            { label: "Bill No", type: "text", key: "bill_no" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Delivery Type", type: "select", options: DATA.deliveryTypes, key: "delivery_type" },
            { label: "L/R No.", type: "text", key: "lr_no", group: "intra" },
            { label: "Transport Mode", type: "text", key: "transport_mode", group: "intra" },
            { label: "Signed Copy Recvd?", type: "select", options: ["No", "Yes"], key: "signed_copy", group: "inter" },
            { label: "Deliv Person", type: "select", options: DATA.employees, key: "deliv_by" },
            { label: "Bill Made By", type: "select", options: DATA.employees, key: "made_by" },
            { label: "Checked By", type: "select", options: DATA.employees, key: "checked_by" },
            { label: "Remark", type: "text", key: "remark" }
        ],
        PURCHASE_RET: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "Return Date", type: "date", key: "date_main" },
            { label: "Location (Filter)", type: "text", key: "location_filter", list: "locations" },
            { label: "Purchaser/Cust", type: "text", key: "party", list: "customers" }, 
            { label: "Brand", type: "select", options: DATA.brands, key: "brand" },
            { label: "Against Bill No", type: "text", key: "against_bill" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Sent By (Remark)", type: "text", key: "remark" },
            { label: "Recvd By", type: "select", options: DATA.employees, key: "Recvd_by" },
            { label: "Approved By", type: "select", options: DATA.employees, key: "approved_by" },
            { label: "Transport recieved", type: "text", key: "transport"},
            { label: "L/R No.", type: "text", key: "L/R_no" }
        ],
        SALES_RET: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "Return Date", type: "date", key: "date_main" },
            { label: "Location (Filter)", type: "text", key: "location_filter", list: "locations" },
            { label: "Purchaser/Cust", type: "text", key: "party", list: "customers" }, 
            { label: "Brand", type: "select", options: DATA.brands, key: "brand" },
            { label: "Against Bill No", type: "text", key: "against_bill" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Sent By (Remark)", type: "text", key: "remark" },
            { label: "Recvd By", type: "select", options: DATA.employees, key: "Recvd_by" },
            { label: "Approved By", type: "select", options: DATA.employees, key: "approved_by" },
            { label: "Transport recieved", type: "text", key: "transport"},
            { label: "L/R No.", type: "text", key: "L/R_no" }
        ]
    };

    // --- STATE ---
    let currentMode = "PURCHASE";
    let allLogs = [];
    let isAdmin = false;
    let editingId = null;

    // --- AUTH ---
    window.attemptLogin = async () => {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        if ((u === "admin" && p === "admin") || (u === "staff" && p === "123")) {
            isAdmin = (u === "admin");
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('actions-header').style.display = 'table-cell';
            
            await loadCustomers();
            renderForm();
            fetchData();
        } else {
            document.getElementById('login-error').innerText = "Invalid Creds";
        }
    };
    window.logout = () => location.reload();

    // --- APP CORE ---
    window.setMode = (mode) => {
        if(editingId) cancelEdit();
        currentMode = mode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('form-title').innerText = `New ${mode.replace('_', ' ')} Entry`;
        renderForm();
    };

    window.updateVisibility = () => {
        if (currentMode !== 'SALES') return;
        const typeSelect = document.querySelector('select[name="delivery_type"]');
        if (!typeSelect) return;
        const type = typeSelect.value;
        
        document.querySelectorAll('.group-intra').forEach(el => el.classList.toggle('hidden-field', type !== 'Intra-city'));
        document.querySelectorAll('.group-inter').forEach(el => el.classList.toggle('hidden-field', type !== 'Inter-city'));
    };

    // --- DYNAMIC LINKED FIELDS LOGIC ---
    window.updateCustomerLists = () => {
        // Only run for SALES mode
        if (currentMode !== 'SALES') return;

        const locInput = document.querySelector('input[name="location_filter"]');
        const custInput = document.querySelector('input[name="party"]');
        if (!locInput || !custInput) return;

        const selectedLoc = locInput.value.toLowerCase().trim();
        const custDatalist = document.getElementById('dl-customers');
        
        // 1. FILTER CUSTOMERS based on Location
        custDatalist.innerHTML = '';
        const filteredCusts = selectedLoc === '' 
            ? CUSTOMER_DB 
            : CUSTOMER_DB.filter(c => c.location.toLowerCase().includes(selectedLoc));
            
        filteredCusts.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            custDatalist.appendChild(opt);
        });
    };

    window.handleCustomerSelect = (e) => {
        const custName = e.target.value;
        const locInput = document.querySelector('input[name="location_filter"]');
        
        // Find exact customer match
        const match = CUSTOMER_DB.find(c => c.name === custName);
        if (match && locInput) {
            locInput.value = match.location; // Auto-fill Location
            updateCustomerLists(); // Re-filter list (optional, keeps UI consistent)
        }
    };

    window.renderForm = (dataToFill = null) => {
        const container = document.getElementById('dynamic-fields');
        container.innerHTML = '';

        const isStaffEdit = (editingId !== null && !isAdmin);
        const staffAllowedFields = ['lr_no', 'transport_mode', 'remark', 'L/R_no', 'transport', 'signed_copy', 'delivery_type'];
        
        // --- 1. BUILD DATALISTS (Hidden & Deduplicated) ---
        const dlContainer = document.createElement('div');
        dlContainer.style.display = 'none';

        // A. SALES: Locations (Fixes "Gadchandur" vs "GADCHANDUR" duplicates)
        // We convert to UpperCase to check for duplicates, but display the original
        const locSet = new Set();
        const uniqueLocs = [];
        
        CUSTOMER_DB.forEach(c => {
            const upper = c.location.toUpperCase().trim();
            if (!locSet.has(upper) && upper.length > 0) {
                locSet.add(upper);
                uniqueLocs.push(c.location.trim()); // Keep one version
            }
        });
        uniqueLocs.sort();

        const locDL = document.createElement('datalist');
        locDL.id = "dl-locations";
        uniqueLocs.forEach(loc => {
            const opt = document.createElement('option');
            opt.value = loc;
            locDL.appendChild(opt);
        });
        dlContainer.appendChild(locDL);

        // B. SALES: Customers (Fixes "A-4GLOBAL" appearing twice)
        const nameSet = new Set();
        const uniqueNames = [];

        CUSTOMER_DB.forEach(c => {
            const name = c.name.trim();
            if (!nameSet.has(name) && name.length > 0) {
                nameSet.add(name);
                uniqueNames.push(name);
            }
        });
        uniqueNames.sort();

        const custDL = document.createElement('datalist');
        custDL.id = "dl-customers";
        uniqueNames.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            custDL.appendChild(opt);
        });
        dlContainer.appendChild(custDL);

        // C. PURCHASE: Sellers (Defaults + Sundry Creditors - Deduplicated)
        const sundrySellers = CUSTOMER_DB
            .filter(c => c.location.toUpperCase().includes("SUNDRY"))
            .map(c => c.name.trim());
        
        // Merge defaults, remove duplicates, and sort
        const allSellers = [...new Set([...DATA.sellers, ...sundrySellers])].sort();

        const sellerDL = document.createElement('datalist');
        sellerDL.id = "dl-purchase_sellers";
        allSellers.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            sellerDL.appendChild(opt);
        });
        dlContainer.appendChild(sellerDL);

        container.appendChild(dlContainer);
        // ----------------------------------

        // --- 2. RENDER FIELDS (Standard Logic) ---
        FORMS[currentMode].forEach(field => {
            const group = document.createElement('div');
            group.className = 'form-group';
            if (field.group) group.classList.add(`group-${field.group}`);
            
            const label = document.createElement('label');
            label.innerText = field.label;
            group.appendChild(label);
            
            let input;
            if (field.type === 'select') {
                input = document.createElement('select');
                field.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.innerText = opt;
                    input.appendChild(option);
                });
            } else {
                input = document.createElement('input');
                input.type = field.type;
                if(field.type === 'number') input.step = "0.01";
                
                if (field.list) {
                    input.setAttribute('list', `dl-${field.list}`);
                }
                
                // Logic: Filter Customer List by Location
                if (field.key === 'location_filter') {
                    input.oninput = (e) => {
                        const loc = e.target.value.toLowerCase();
                        const targetList = document.getElementById('dl-customers');
                        targetList.innerHTML = '';
                        
                        // Deduplicate filtered results on the fly
                        const added = new Set();
                        
                        CUSTOMER_DB.filter(c => c.location.toLowerCase().includes(loc))
                            .forEach(c => {
                                if (!added.has(c.name)) { // Prevent duplicates in search results
                                    added.add(c.name);
                                    const opt = document.createElement('option');
                                    opt.value = c.name;
                                    targetList.appendChild(opt);
                                }
                            });
                    };
                }
                // Logic: Auto-fill Location from Customer Name
                if (field.key === 'party' && currentMode === 'SALES') {
                    input.onchange = (e) => {
                         const match = CUSTOMER_DB.find(c => c.name === e.target.value);
                         const locInput = document.querySelector('input[name="location_filter"]');
                         if(match && locInput) locInput.value = match.location;
                    };
                }
            }
            
            input.name = field.key;
            if (field.key === 'delivery_type') input.onchange = updateVisibility;

            if(dataToFill && dataToFill[field.key]) input.value = dataToFill[field.key];

            if (isStaffEdit && !staffAllowedFields.includes(field.key)) {
                input.disabled = true;
                input.style.backgroundColor = "#e5e7eb";
            }

            const optionalFields = ['remark', 'against_bill', 'credit_note_no', 'lr_no', 'transport_mode', 'L/R_no', 'transport', 'signed_copy', 'location_filter'];
            if (!optionalFields.includes(field.key)) input.required = true;
            
            if(field.type === 'date' && !dataToFill) input.valueAsDate = new Date();
            
            group.appendChild(input);
            container.appendChild(group);
        });

        if (currentMode === 'SALES') updateVisibility();
    };
    
    window.submitData = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('save-btn');
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;

        const formData = new FormData(e.target);
        const data = { type: currentMode, timestamp: new Date() };
        
        if (editingId && !isAdmin) {
             const oldLog = allLogs.find(l => l.id === editingId);
             Object.assign(data, oldLog); 
             delete data.id; 
        }
        formData.forEach((value, key) => data[key] = value);

        try {
            if (editingId) {
                await updateDoc(doc(db, "logs", editingId), data);
                alert("Updated!");
                cancelEdit();
            } else {
                await addDoc(collection(db, "logs"), data);
                alert("Saved!");
                e.target.reset();
                renderForm(); 
            }
            fetchData(); 
        } catch (error) { console.error(error); alert("Error saving."); }
        btn.innerText = originalText;
        btn.disabled = false;
    };

    async function fetchData() {
        const q = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(50));
        const snap = await getDocs(q);
        allLogs = [];
        snap.forEach((doc) => allLogs.push({ id: doc.id, ...doc.data() }));
        renderTable();
    }

    window.renderTable = () => {
        const tbody = document.querySelector('#dataTable tbody');
        const search = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';
        const filtered = allLogs.filter(log => Object.values(log).join(' ').toLowerCase().includes(search));
        
        filtered.forEach(log => {
            const tr = document.createElement('tr');
            const date = log.date_bill || log.date_lr || log.date_main || "N/A";
            const party = log.party || log.brand || "-";
            const btnHtml = isAdmin ? 
                `<button class="action-btn btn-edit" onclick="startEdit('${log.id}')">Edit</button><button class="action-btn btn-delete" onclick="deleteEntry('${log.id}')">Del</button>` : 
                `<button class="action-btn btn-edit" onclick="startEdit('${log.id}')">Edit</button>`;

            tr.innerHTML = `<td>${date}</td><td><span style="font-size:0.8em; padding:2px 5px; background:#e5e7eb;">${log.type}</span></td><td>${log.firm}</td><td>${party}</td><td>${log.bill_no || log.against_bill || '-'}</td><td>${log.pcs || '-'}</td><td>${log.amount || '-'}</td><td>${btnHtml}</td>`;
            tbody.appendChild(tr);
        });
    }

    window.deleteEntry = async (id) => { if(confirm("Delete?")) { await deleteDoc(doc(db, "logs", id)); fetchData(); }};

    window.startEdit = (id) => {
        const log = allLogs.find(l => l.id === id);
        if (!log) return;
        setMode(log.type);
        editingId = id; 
        renderForm(log);
        document.getElementById('edit-notice').style.display = 'block';
        document.getElementById('save-btn').innerText = isAdmin ? "Update Entry" : "Update Delivery Info"; 
        document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
    };

    window.cancelEdit = () => {
        editingId = null;
        document.getElementById('edit-notice').style.display = 'none';
        document.getElementById('save-btn').innerText = "Save Entry";
        document.getElementById('logForm').reset();
        renderForm(); 
    };
</script>
</body>
</html>
