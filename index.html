<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firm Logistics Manager</title>
    
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --white: #ffffff; --danger: #ef4444; --warning: #f59e0b; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        .container { max-width: 1200px; margin: 0 auto; display: none; } /* Increased width for bill table */
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f3f4f6; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 300px; text-align: center; }
        .login-box input { width: 90%; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .login-box button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: #ddd; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .tab.active { background: var(--primary); color: var(--white); }
        
        .sub-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .sub-tab { padding: 5px 15px; background: white; border: 1px solid #ccc; border-radius: 15px; cursor: pointer; font-size: 0.9rem; }
        .sub-tab.active { background: #374151; color: white; border-color: #374151; }

        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; } 
        
        .hidden-field { display: none !important; }

        label { font-size: 0.85rem; color: #555; margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        button.submit-btn { background: #10b981; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 20px; width: 100%; }
        
        /* NEW STYLES FOR BILLING TABLE */
        .bill-table-container { margin-top: 20px; overflow-x: auto; border: 1px solid #eee; border-radius: 4px; }
        .bill-table { width: 100%; min-width: 800px; border-collapse: collapse; font-size: 0.85rem; }
        .bill-table th { background: #f3f4f6; padding: 8px; text-align: left; border-bottom: 2px solid #ddd; }
        .bill-table td { padding: 5px; border-bottom: 1px solid #eee; }
        .bill-table input { padding: 5px; font-size: 0.9rem; border: 1px solid #ddd; }
        .bill-table input:focus { border-color: var(--primary); outline: none; }
        .bill-actions { margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .total-box { font-size: 1.2rem; font-weight: bold; color: var(--text); }
        .remove-row-btn { color: var(--danger); background: none; border: none; cursor: pointer; font-size: 1.2rem; }

        .manage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .manage-list { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        .manage-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .manage-item:hover { background: #f9fafb; }

        /* Modal (Popup) Styles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 900px; padding: 25px; border-radius: 8px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .bill-details-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #f9fafb; padding: 15px; border-radius: 5px; }
        .full-bill-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .full-bill-table th { background: #374151; color: white; padding: 10px; text-align: left; }
        .full-bill-table td { border-bottom: 1px solid #eee; padding: 8px; }
        .bill-footer { margin-top: 20px; text-align: right; font-size: 1.2rem; font-weight: bold; border-top: 2px solid #374151; padding-top: 10px; }
        
        .table-controls { display: flex; justify-content: space-between; margin-bottom: 10px; }
        table.main-table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9rem; }
        table.main-table th, table.main-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        table.main-table th { background: #f8f9fa; }
        table.main-table tr:hover { background: #f1f5f9; }
        
        .action-btn { padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer; color: white; margin-right: 5px; font-size: 0.8rem; }
        .btn-edit { background: var(--warning); color: black; }
        .btn-delete { background: var(--danger); }

        @media (max-width: 600px) { 
            .table-controls { flex-direction: column; gap: 10px; } 
            .manage-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="bill-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin:0;">Cash Sale Details</h2>
            <button class="close-modal" onclick="closeBillModal()">&times;</button>
        </div>
        
        <div class="bill-details-grid">
            <div><strong>Date:</strong> <span id="view-date">-</span></div>
            <div><strong>Customer:</strong> <span id="view-party">-</span></div>
            <div><strong>Payment:</strong> <span id="view-type">-</span> <span id="view-status"></span></div>
        </div>

        <table class="full-bill-table">
            <thead>
                <tr>
                    <th>Barcode</th>
                    <th>Article No</th>
                    <th>Name</th>
                    <th>Size</th>
                    <th>Color</th>
                    <th>MRP</th>
                    <th>Pcs</th>
                    <th>WSP</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="view-bill-body">
                </tbody>
        </table>

        <div class="bill-footer">
            Grand Total: ‚Çπ<span id="view-grand-total">0.00</span>
        </div>
    </div>
</div>

<div id="login-overlay">
    <div class="login-box">
        <h2 id="auth-title">System Login</h2>
        <input type="email" id="email" placeholder="Email (staff@firm.com)">
        <input type="password" id="password" placeholder="Password">
        
        <div id="login-actions">
            <button onclick="handleAuth()">Login</button>
            <p style="font-size:0.8rem; margin-top:10px;">
                Staff member? <a href="#" onclick="toggleAuthMode(true)">Register here</a>
            </p>
        </div>

        <div id="register-actions" style="display:none;">
            <button onclick="handleAuth()" style="background:#10b981;">Register Staff Account</button>
            <p style="font-size:0.8rem; margin-top:10px;">
                Back to <a href="#" onclick="toggleAuthMode(false)">Login</a>
            </p>
        </div>
        
        <p id="login-error" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
    </div>
</div>

<div class="container" id="app-container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Logistics Management</h2>
        <div style="text-align:right;">
             <button onclick="logout()" style="background:#eee; border:none; padding:5px 10px; cursor:pointer;">Logout</button>
             <button onclick="forceRefreshData()" style="background:#eee; border:none; padding:5px 10px; cursor:pointer; font-size:0.8rem;">‚ö†Ô∏è Force Sync</button>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="setMode('PURCHASE')">PURCHASE</button>
        <button class="tab" onclick="setMode('SALES')">SALES</button>
        <button class="tab" onclick="setMode('CASH_SALE')">CASH SALE</button> <button class="tab" onclick="setMode('PURCHASE_RET')">PURCHASE RETURN</button>
        <button class="tab" onclick="setMode('SALES_RET')">SALES RETURN</button>
        <button class="tab" style="background:#374151; color:white;" onclick="setMode('MANAGE')">MANAGE DATA</button>
    </div>

    <div class="card" id="log-entry-card">
        <h3 id="form-title">New Entry</h3>
        <p id="edit-notice" style="display:none; color: var(--warning); font-size: 0.9rem;">‚ö†Ô∏è You are editing an existing record. <button type="button" onclick="cancelEdit()" style="text-decoration:underline; border:none; background:none; cursor:pointer; color:blue;">Cancel</button></p>
        
        <form id="logForm" onsubmit="submitData(event)">
            <div class="form-grid" id="dynamic-fields"></div>
            
            <div id="billing-section" style="display:none;">
                <div class="bill-table-container">
                    <table class="bill-table" id="billTable">
                        <thead>
                            <tr>
                                <th style="width:15%">Barcode</th>
                                <th style="width:15%">Name</th>
                                <th style="width:10%">Art No</th>
                                <th style="width:10%">Size</th>
                                <th style="width:10%">Color</th>
                                <th style="width:10%">MRP</th>
                                <th style="width:8%">Pcs</th>
                                <th style="width:12%">Rate (WSP)</th>
                                <th style="width:12%">Total</th> 
                                <th style="width:5%"></th>
                            </tr>
                        </thead>
                        <tbody id="billTableBody">
                            </tbody>
                    </table>
                </div>
                <div class="bill-actions">
                    <button type="button" onclick="addBillRow()" style="background:#e5e7eb; color:black; padding:5px 10px; border:none; border-radius:4px; cursor:pointer;">+ Add Item</button>
                    <div class="total-box">Total: ‚Çπ<span id="billTotalDisplay">0.00</span></div>
                </div>
                <input type="hidden" name="total_bill_amount" id="total_bill_amount" value="0">
            </div>

            <button type="submit" class="submit-btn" id="save-btn">Save Entry</button>
        </form>
    </div>

    <div class="card" id="manage-ui-card" style="display:none;">
        <h3>Manage Database</h3>
        
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="setManageType('CUSTOMER')">Customers</button>
            <button class="sub-tab" onclick="setManageType('SELLER')">Sellers</button>
            <button class="sub-tab" id="tab-emp" onclick="setManageType('EMPLOYEE')">Employees</button>
        </div>

        <div class="manage-grid">
            <div style="background:#f9fafb; padding:15px; border-radius:8px;">
                <h4 style="margin-top:0;">Add New <span id="manage-type-label">Customer</span></h4>
                <form onsubmit="submitManageData(event)">
                    <input type="text" id="new-name" placeholder="Name" onkeyup="renderManageList(this.value)" required>
                    <input type="text" id="new-location" placeholder="Location" required>
                    <button type="submit" class="submit-btn" style="margin-top:10px;">Add to Database</button>
                </form>
            </div>

            <div>
                <input type="text" id="manage-search" placeholder="Search..." onkeyup="renderManageList()">
                <div class="manage-list" id="manage-list-container"></div>
            </div>
        </div>
    </div>

    <div class="card" id="table-card">
        <div class="table-controls">
            <h3>Recent Logs</h3>
            <input type="text" id="searchInput" placeholder="Search Bill No, Firm, Name..." onkeyup="renderTable()">
        </div>
        <div style="overflow-x:auto;">
            <table class="main-table" id="dataTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Firm</th>
                        <th>Party/Brand</th>
                        <th>Details</th> <th>Pcs</th>
                        <th>Amt</th>
                        <th id="actions-header" style="display:none;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { initializeFirestore, collection, addDoc, getDocs, query, orderBy, limit, deleteDoc, updateDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBBszqQlych7F1g82TA37y6Bvhj6EwFfdg",
        authDomain: "logistics-app-mona-rnc.firebaseapp.com",
        projectId: "logistics-app-mona-rnc",
        storageBucket: "logistics-app-mona-rnc.firebasestorage.app",
        messagingSenderId: "989428986519",
        appId: "1:989428986519:web:cdcea9bd1b6aecdb9d2fd2",
        measurementId: "G-LSP2HCVPKC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = initializeFirestore(app, {
        experimentalForceLongPolling: true,
        useFetchStreams: false
    });

    // --- STATE ---
    let isRegistering = false;
    let currentMode = "PURCHASE";
    let manageType = "CUSTOMER"; 
    let allLogs = [];
    let isAdmin = false;
    let editingId = null;
    let CUSTOMER_DB = [];
    let EMPLOYEE_DB = [];

    const DATA = {
        firms: ["Mona", "RNC"],
        brands: ["Jockey", "Amante", "Sweet Dreams"],
        deliveryTypes: ["Intra-city", "Inter-city"]
    };

    // --- AUTH ---
    window.toggleAuthMode = (register) => {
        isRegistering = register;
        document.getElementById('auth-title').innerText = register ? "Staff Registration" : "System Login";
        document.getElementById('login-actions').style.display = register ? 'none' : 'block';
        document.getElementById('register-actions').style.display = register ? 'block' : 'none';
    };

    window.handleAuth = async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const errorEl = document.getElementById('login-error');
        errorEl.innerText = "Processing...";
        try {
            if (isRegistering) {
                await createUserWithEmailAndPassword(auth, email, pass);
                alert("Staff Registered!");
            } else {
                await signInWithEmailAndPassword(auth, email, pass);
            }
        } catch (error) { errorEl.innerText = error.message.replace("Firebase: ", ""); }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            isAdmin = (user.email === "mayur8479@gmail.com"); 
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('actions-header').style.display = 'table-cell';
            if(!isAdmin) document.getElementById('tab-emp').style.display = 'none';
            await loadAllData();
            renderForm();
            fetchData();
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }
    });

    window.logout = () => signOut(auth);

    // --- DATA LOADING ---
    async function loadAllData() { await Promise.all([loadCustomers(), loadEmployees()]); }
    
    async function loadCustomers() {
        const cached = localStorage.getItem('customer_db');
        if (cached && cached !== "[]") { CUSTOMER_DB = JSON.parse(cached); } 
        else {
            try {
                const snap = await getDocs(query(collection(db, "customers")));
                CUSTOMER_DB = [];
                snap.forEach(doc => CUSTOMER_DB.push({ id: doc.id, ...doc.data() }));
                localStorage.setItem('customer_db', JSON.stringify(CUSTOMER_DB));
            } catch(e) { console.error(e); }
        }
    }
    async function loadEmployees() {
        const cached = localStorage.getItem('employee_db');
        if (cached && cached !== "[]") { EMPLOYEE_DB = JSON.parse(cached); } 
        else {
            try {
                const snap = await getDocs(query(collection(db, "employees")));
                EMPLOYEE_DB = [];
                snap.forEach(doc => EMPLOYEE_DB.push({ id: doc.id, ...doc.data() }));
                localStorage.setItem('employee_db', JSON.stringify(EMPLOYEE_DB));
            } catch(e) { console.error(e); }
        }
    }

    // --- FORM CONFIGURATION ---
    const FORMS = {
        PURCHASE: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "L/R Date", type: "date", key: "date_lr" },
            { label: "L/R No.", type: "text", key: "L/R_no" },
            { label: "Bill Date", type: "date", key: "date_bill" },
            { label: "Bill No.", type: "text", key: "bill_no" },
            { label: "Date Recd", type: "date", key: "date_recd" },
            { label: "Seller Name", type: "text", key: "party", list: "purchase_sellers" },
            { label: "Cartons", type: "number", key: "cartons" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Recd By", type: "text", key: "recd_by", list: "employees" },
            { label: "Checked By", type: "text", key: "checked_by", list: "employees" },
            { label: "Remark", type: "text", key: "remark" }
        ],
        SALES: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "Bill Date", type: "date", key: "date_bill" },
            { label: "Delivery Date", type: "date", key: "date_deliv" },
            { label: "Location (Filter)", type: "text", key: "location_filter", list: "locations" },
            { label: "Purchaser/Cust", type: "text", key: "party", list: "customers" },
            { label: "Brand", type: "select", options: DATA.brands, key: "brand" },
            { label: "Bill No", type: "text", key: "bill_no" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Delivery Type", type: "select", options: DATA.deliveryTypes, key: "delivery_type" },
            { label: "L/R No.", type: "text", key: "lr_no", group: "intra" },
            { label: "Transport Mode", type: "text", key: "transport_mode", group: "intra" },
            { label: "Signed Copy Recvd?", type: "select", options: ["No", "Yes"], key: "signed_copy", group: "inter" },
            { label: "Deliv Person", type: "text", key: "deliv_by", list: "employees" },
            { label: "Bill Made By", type: "text", key: "made_by", list: "employees" },
            { label: "Checked By", type: "text", key: "checked_by", list: "employees" },
            { label: "Remark", type: "text", key: "remark" }
        ],
        // --- NEW CASH SALE CONFIG (Header only) ---
        CASH_SALE: [
            { label: "Date", type: "date", key: "date_main" },
            { label: "Customer Name", type: "text", key: "customer_cash_sale" },
            { label: "Payment Type", type: "select", options: ["CASH", "CREDIT", "UPI"], key: "payment_type" },
            { label: "Credit Paid?", type: "checkbox", key: "is_paid", group: "credit-only" }
        ],
        PURCHASE_RET: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "Return Date", type: "date", key: "date_main" },
            { label: "Target Brand", type: "select", options: DATA.brands, key: "party" },
            { label: "Against Bill No", type: "text", key: "against_bill" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Sent By (Remark)", type: "text", key: "remark" }
        ],
        SALES_RET: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "Return Date", type: "date", key: "date_main" },
            { label: "Customer", type: "text", key: "party", list: "customers" }, 
            { label: "Brand", type: "select", options: DATA.brands, key: "brand" },
            { label: "Against Bill No", type: "text", key: "against_bill" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Sent By (Remark)", type: "text", key: "remark" },
            { label: "Recvd By", type: "text", key: "Recvd_by", list: "employees" },
            { label: "Approved By", type: "text", key: "approved_by", list: "employees" },
            { label: "L/R No.", type: "text", key: "L/R_no" }
        ]
    };

    // --- FORM RENDERING ---
    window.renderForm = (dataToFill = null) => {
        const container = document.getElementById('dynamic-fields');
        container.innerHTML = '';
        const isStaffEdit = (editingId !== null && !isAdmin);
        const staffAllowedFields = ['lr_no', 'transport_mode', 'remark', 'L/R_no', 'transport', 'signed_copy', 'delivery_type', 'is_paid', 'payment_type'];
        
        // 1. Setup Datalists
        const dlContainer = document.createElement('div');
        dlContainer.style.display = 'none';
        
        const locDL = document.createElement('datalist'); locDL.id = "dl-locations";
        [...new Set(CUSTOMER_DB.map(c => c.location))].sort().forEach(l => { const o = document.createElement('option'); o.value = l; locDL.appendChild(o); });
        
        const custDL = document.createElement('datalist'); custDL.id = "dl-customers";
        CUSTOMER_DB.filter(c => c.location !== "Sundry Creditors").forEach(c => { const o = document.createElement('option'); o.value = c.name; custDL.appendChild(o); });
        
        const sellerDL = document.createElement('datalist'); sellerDL.id = "dl-purchase_sellers";
        const sundry = CUSTOMER_DB.filter(c => c.location === "Sundry Creditors").map(c => c.name);
        [...new Set(["Milton", "Apna Bazaar", "Karachu", ...sundry])].sort().forEach(n => { const o = document.createElement('option'); o.value = n; sellerDL.appendChild(o); });

        const empDL = document.createElement('datalist'); empDL.id = "dl-employees";
        EMPLOYEE_DB.forEach(e => { const o = document.createElement('option'); o.value = e.name; empDL.appendChild(o); });

        dlContainer.append(locDL, custDL, sellerDL, empDL);
        container.appendChild(dlContainer);

        // 2. Render Header Fields
        FORMS[currentMode].forEach(field => {
            const group = document.createElement('div');
            group.className = 'form-group';
            if (field.group) group.classList.add(`group-${field.group}`);
            
            const label = document.createElement('label');
            label.innerText = field.label;
            group.appendChild(label);
            
            let input;
            if (field.type === 'select') {
                input = document.createElement('select');
                field.options.forEach(opt => { const option = document.createElement('option'); option.value = opt; option.innerText = opt; input.appendChild(option); });
            } else {
                input = document.createElement('input');
                input.type = field.type;
                if(field.type === 'number') input.step = "0.01";
                if(field.list) input.setAttribute('list', `dl-${field.list}`);
                if(field.type === 'checkbox') input.style.width = '20px';
            }
            
            input.name = field.key;
            if(dataToFill && dataToFill[field.key]) {
                if(field.type === 'checkbox') input.checked = dataToFill[field.key];
                else input.value = dataToFill[field.key];
            }
            if(field.type === 'date' && !dataToFill) input.valueAsDate = new Date();
            
            // Event Listeners
            if (field.key === 'payment_type' || field.key === 'delivery_type') input.onchange = updateVisibility;
            
            if (isStaffEdit && !staffAllowedFields.includes(field.key)) { input.disabled = true; input.style.backgroundColor = "#e5e7eb"; }
            if(field.type !== 'checkbox' && field.key !== 'remark' && field.key !== 'is_paid') input.required = true;

            group.appendChild(input);
            container.appendChild(group);
        });

        // 3. Handle Cash Sale Table
        const billSection = document.getElementById('billing-section');
        const billBody = document.getElementById('billTableBody');
        billBody.innerHTML = ''; // Clear prev rows

        if (currentMode === 'CASH_SALE') {
            billSection.style.display = 'block';
            if(dataToFill && dataToFill.items) {
                dataToFill.items.forEach(item => addBillRow(item));
            } else {
                // Add 1 empty row by default
                addBillRow(); 
            }
            calcBillTotal();
        } else {
            billSection.style.display = 'none';
        }

        updateVisibility();
    };

    // --- BILL TABLE LOGIC ---
    window.addBillRow = (data = null) => {
        const tbody = document.getElementById('billTableBody');
        const tr = document.createElement('tr');
        
        // Define cells: [Key, Placeholder, Type, Value, Class, ReadOnly]
        const cells = [
            { k: 'barcode', p: 'Scan...' },
            { k: 'name', p: 'Item Name' },
            { k: 'art_no', p: 'Art#' },
            { k: 'size', p: 'Size' },
            { k: 'color', p: 'Color' },
            { k: 'mrp', p: 'MRP', t: 'number' },
            { k: 'pcs', p: '1', t: 'number', v: 1, cls: 'calc-trigger' },
            { k: 'wsp', p: 'Price', t: 'number', cls: 'calc-trigger' },
            // NEW: Row Total Cell (Readonly)
            { k: 'row_total', p: '0.00', t: 'number', ro: true } 
        ];

        cells.forEach(c => {
            const td = document.createElement('td');
            const inp = document.createElement('input');
            inp.type = c.t || 'text';
            inp.placeholder = c.p;
            inp.name = `item_${c.k}[]`; 
            
            if(c.t === 'number') inp.step = '0.01';
            if(c.ro) {
                inp.readOnly = true;
                inp.style.backgroundColor = '#f9fafb'; // Light grey for readonly
                inp.style.border = 'none';
                inp.style.fontWeight = 'bold';
            }

            // Fill data if editing or default value
            if(data && data[c.k]) inp.value = data[c.k];
            else if(c.v) inp.value = c.v;

            if(c.cls === 'calc-trigger') inp.oninput = calcBillTotal;
            td.appendChild(inp);
            tr.appendChild(td);
        });

        // Delete Button
        const delTd = document.createElement('td');
        delTd.innerHTML = `<button type="button" class="remove-row-btn" onclick="removeBillRow(this)">√ó</button>`;
        tr.appendChild(delTd);
        
        tbody.appendChild(tr);
    };

    window.removeBillRow = (btn) => {
        const row = btn.closest('tr');
        if(document.querySelectorAll('#billTableBody tr').length > 1) {
            row.remove();
            calcBillTotal();
        }
    };

    window.calcBillTotal = () => {
        let grandTotal = 0;
        
        document.querySelectorAll('#billTableBody tr').forEach(tr => {
            // 1. Get inputs for this specific row
            const pcsInput = tr.querySelector('input[name="item_pcs[]"]');
            const rateInput = tr.querySelector('input[name="item_wsp[]"]');
            const totalInput = tr.querySelector('input[name="item_row_total[]"]');

            // 2. Parse values (default to 0 if empty)
            const pcs = parseFloat(pcsInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;

            // 3. Calculate Row Total
            const rowTotal = pcs * rate;

            // 4. Update the Row Total Input
            if(totalInput) totalInput.value = rowTotal.toFixed(2);

            // 5. Add to Grand Total
            grandTotal += rowTotal;
        });

        // Update Bottom Total Display
        document.getElementById('billTotalDisplay').innerText = grandTotal.toFixed(2);
        document.getElementById('total_bill_amount').value = grandTotal;
    };

    window.updateVisibility = () => {
        if (currentMode === 'SALES') {
            const typeSelect = document.querySelector('select[name="delivery_type"]');
            if (typeSelect) {
                const type = typeSelect.value;
                document.querySelectorAll('.group-intra').forEach(el => el.classList.toggle('hidden-field', type !== 'Intra-city'));
                document.querySelectorAll('.group-inter').forEach(el => el.classList.toggle('hidden-field', type !== 'Inter-city'));
            }
        }
        if (currentMode === 'CASH_SALE') {
            const payType = document.querySelector('select[name="payment_type"]');
            if (payType) {
                const isCredit = payType.value === "CREDIT";
                document.querySelectorAll('.group-credit-only').forEach(el => el.classList.toggle('hidden-field', !isCredit));
            }
        }
    };

    // --- SUBMISSION ---
    window.submitData = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('save-btn');
        btn.disabled = true;
        btn.innerText = "Saving...";

        const formData = new FormData(e.target);
        const data = { type: currentMode, timestamp: new Date() };

        // 1. Process Standard Fields
        formData.forEach((value, key) => {
            if(!key.startsWith('item_')) data[key] = value;
        });
        
        // 2. Process Cash Sale Items
        if(currentMode === 'CASH_SALE') {
            const items = [];
            const rows = document.querySelectorAll('#billTableBody tr');
            let totalPcs = 0;
            
            rows.forEach(tr => {
                const item = {
                    barcode: tr.querySelector('input[name="item_barcode[]"]').value,
                    name: tr.querySelector('input[name="item_name[]"]').value,
                    art_no: tr.querySelector('input[name="item_art_no[]"]').value,
                    size: tr.querySelector('input[name="item_size[]"]').value,
                    color: tr.querySelector('input[name="item_color[]"]').value,
                    mrp: tr.querySelector('input[name="item_mrp[]"]').value,
                    pcs: parseFloat(tr.querySelector('input[name="item_pcs[]"]').value) || 0,
                    wsp: parseFloat(tr.querySelector('input[name="item_wsp[]"]').value) || 0
                };
                if(item.barcode || item.name) { // Only save if has content
                    items.push(item);
                    totalPcs += item.pcs;
                }
            });

            data.items = items;
            data.pcs = totalPcs; // For main table summary
            data.amount = document.getElementById('total_bill_amount').value; // For main table summary
            data.is_paid = document.querySelector('input[name="is_paid"]')?.checked || false;
        }

        try {
            if (editingId) {
                await updateDoc(doc(db, "logs", editingId), data);
                alert("Updated!");
                cancelEdit();
            } else {
                await addDoc(collection(db, "logs"), data);
                alert("Saved!");
                e.target.reset();
                renderForm(); 
            }
            fetchData(); 
        } catch (error) { console.error(error); alert(error.message); }
        btn.disabled = false;
        btn.innerText = "Save Entry";
    };

    window.renderTable = () => {
        const tbody = document.querySelector('#dataTable tbody');
        const search = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';
        
        const filtered = allLogs.filter(log => {
            let itemStr = "";
            if(log.items) itemStr = log.items.map(i => `${i.name} ${i.barcode}`).join(" ");
            const fullStr = Object.values(log).join(' ') + " " + itemStr;
            return fullStr.toLowerCase().includes(search);
        });
        
        filtered.forEach(log => {
            const tr = document.createElement('tr');
            const date = log.date_bill || log.date_lr || log.date_main || "N/A";
            const party = log.party || log.brand || "-";
            
            // Custom "Details" Column Logic
            let details = log.bill_no || log.against_bill || '-';
            if(log.type === 'CASH_SALE') {
                const itemCount = log.items ? log.items.length : 0;
                const payStatus = log.payment_type === 'CREDIT' ? (log.is_paid ? '‚úÖ' : '‚ùå') : '';
                details = `${itemCount} Items [${log.payment_type || '-'}] ${payStatus}`;
            }

            tr.innerHTML = `
                <td>${date}</td>
                <td><span style="font-size:0.8em; padding:2px 5px; background:#e5e7eb;">${log.type}</span></td>
                <td>${log.firm || '-'}</td>
                <td>${party}</td>
                <td>${details}</td>
                <td>${log.pcs || '-'}</td>
                <td>${log.amount || '-'}</td>
            `;

            const actionTd = document.createElement('td');
            
            // NEW: View Button for Cash Sales
            if(log.type === 'CASH_SALE') {
                actionTd.innerHTML += `<button class="action-btn" style="background:#3b82f6;" onclick="viewBill('${log.id}')">üìÑ View</button> `;
            }

            actionTd.innerHTML += `<button class="action-btn btn-edit" onclick="startEdit('${log.id}')">Edit</button>`;
            
            if (isAdmin) {
                actionTd.innerHTML += `<button class="action-btn btn-delete" onclick="deleteItemLog('${log.id}', this)" style="margin-left:5px;">Del</button>`;
            }
            tr.appendChild(actionTd);
            tbody.appendChild(tr);
        });
    };

    // --- GENERIC FUNCTIONS ---
    window.setMode = (mode) => {
        currentMode = mode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        if (mode === 'MANAGE') {
            document.getElementById('log-entry-card').style.display = 'none';
            document.getElementById('table-card').style.display = 'none';
            document.getElementById('manage-ui-card').style.display = 'block';
            setManageType('CUSTOMER'); 
        } else {
            if(editingId) cancelEdit();
            document.getElementById('log-entry-card').style.display = 'block';
            document.getElementById('table-card').style.display = 'block';
            document.getElementById('manage-ui-card').style.display = 'none';
            document.getElementById('form-title').innerText = `New ${mode.replace('_', ' ')} Entry`;
            renderForm();
        }
    };

    window.startEdit = (id) => {
        const log = allLogs.find(l => l.id === id);
        if (!log) return;
        setMode(log.type);
        editingId = id; 
        renderForm(log);
        document.getElementById('edit-notice').style.display = 'block';
        document.getElementById('save-btn').innerText = isAdmin ? "Update Entry" : "Update Delivery Info"; 
        document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
    };

    window.cancelEdit = () => {
        editingId = null;
        document.getElementById('edit-notice').style.display = 'none';
        document.getElementById('save-btn').innerText = "Save Entry";
        document.getElementById('logForm').reset();
        renderForm(); 
    };

    window.deleteItemLog = async (id, btn) => {
        if(!confirm("Delete this log?")) return;
        try { await deleteDoc(doc(db, "logs", id)); fetchData(); }
        catch(e) { alert(e.message); }
    };

    async function fetchData() {
        try {
            const q = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(50));
            const snap = await getDocs(q);
            allLogs = [];
            snap.forEach((doc) => allLogs.push({ id: doc.id, ...doc.data() }));
            renderTable();
        } catch(e) { console.error(e); }
    }
    
    // Manage functions (unchanged logic)
    window.setManageType = (type) => {
        manageType = type;
        document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
        // ... (standard logic to highlight tab)
        document.getElementById('manage-type-label').innerText = type;
        renderManageList();
    };
    window.renderManageList = (s) => { /* Reuse your existing logic or I can fill if needed */ 
        const container = document.getElementById('manage-list-container');
        let search = (s || document.getElementById('manage-search').value).toLowerCase();
        container.innerHTML = '';
        let list = (manageType === 'CUSTOMER') ? CUSTOMER_DB.filter(c => c.location !== "Sundry Creditors") 
                 : (manageType === 'SELLER') ? CUSTOMER_DB.filter(c => c.location === "Sundry Creditors") 
                 : EMPLOYEE_DB;
        
        list.filter(i => i.name.toLowerCase().includes(search)).sort((a,b)=>a.name.localeCompare(b.name)).forEach(item => {
            const div = document.createElement('div');
            div.className = 'manage-item';
            div.innerHTML = `<div><strong>${item.name}</strong></div>`;
            if(isAdmin) div.innerHTML += `<button class="action-btn btn-delete" onclick="deleteItem('${item.id}', '${manageType}', this)">Del</button>`;
            container.appendChild(div);
        });
    };
    window.deleteItem = async (id, type, btn) => {
        if(!confirm("Delete?")) return;
        const coll = type === 'EMPLOYEE' ? 'employees' : 'customers';
        await deleteDoc(doc(db, coll, id));
        // Update local cache manually to save read
        if(type==='EMPLOYEE') EMPLOYEE_DB = EMPLOYEE_DB.filter(x=>x.id!==id);
        else CUSTOMER_DB = CUSTOMER_DB.filter(x=>x.id!==id);
        renderManageList();
    };
    window.submitManageData = async (e) => {
        e.preventDefault();
        const name = document.getElementById('new-name').value.toUpperCase();
        const loc = document.getElementById('new-location').value.toUpperCase();
        const id = name.replace(/\W/g,'_') + '_' + Math.floor(Math.random()*1000);
        const data = { name, location: (manageType==='SELLER'?'Sundry Creditors':loc) };
        const coll = manageType==='EMPLOYEE'?'employees':'customers';
        await setDoc(doc(db, coll, id), data);
        if(manageType==='EMPLOYEE') EMPLOYEE_DB.push({id,...data});
        else CUSTOMER_DB.push({id,...data});
        renderManageList();
        e.target.reset();
    };
    window.forceRefreshData = () => { localStorage.clear(); location.reload(); };

    // --- MODAL FUNCTIONS ---
    window.viewBill = (id) => {
        const log = allLogs.find(l => l.id === id);
        if (!log || !log.items) { alert("No item details found for this log."); return; }

        // 1. Fill Header Info
        document.getElementById('view-date').innerText = log.date_main || '-';
        document.getElementById('view-party').innerText = log.party || 'Generic';
        document.getElementById('view-type').innerText = log.payment_type || 'CASH';
        document.getElementById('view-status').innerHTML = (log.payment_type === 'CREDIT') 
            ? (log.is_paid ? '<span style="color:green; font-weight:bold;">(PAID)</span>' : '<span style="color:red; font-weight:bold;">(UNPAID)</span>') 
            : '';

        // 2. Fill Table Rows
        const tbody = document.getElementById('view-bill-body');
        tbody.innerHTML = '';
        
        log.items.forEach(item => {
            const rowTotal = (parseFloat(item.pcs) || 0) * (parseFloat(item.wsp) || 0);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.barcode || '-'}</td>
                <td>${item.art_no || '-'}</td>
                <td>${item.name || '-'}</td>
                <td>${item.size || '-'}</td>
                <td>${item.color || '-'}</td>
                <td>${item.mrp || '-'}</td>
                <td>${item.pcs || '-'}</td>
                <td>${item.wsp || '-'}</td>
                <td><strong>${rowTotal.toFixed(2)}</strong></td>
            `;
            tbody.appendChild(tr);
        });

        // 3. Fill Footer
        document.getElementById('view-grand-total').innerText = log.amount || '0.00';

        // 4. Show Modal
        document.getElementById('bill-modal').style.display = 'flex';
    };

    window.closeBillModal = () => {
        document.getElementById('bill-modal').style.display = 'none';
    };

    // --- EXPORTS ---
    window.deleteItemLog = deleteItemLog;
    window.deleteItem = deleteItem;
    window.forceRefreshData = forceRefreshData;
    window.setMode = setMode;
    window.setManageType = setManageType;
    window.renderManageList = renderManageList;
    window.renderTable = renderTable;
    window.startEdit = startEdit;
    window.cancelEdit = cancelEdit;
    window.submitData = submitData;
    window.submitManageData = submitManageData;
    window.addBillRow = addBillRow;
    window.removeBillRow = removeBillRow;
    window.calcBillTotal = calcBillTotal;
    window.viewBill = viewBill;
    window.closeBillModal = closeBillModal;

</script>
</body>
</html>
