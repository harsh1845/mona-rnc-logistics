<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firm Logistics Manager</title>
    
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --white: #ffffff; --danger: #ef4444; --warning: #f59e0b; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        .container { max-width: 1000px; margin: 0 auto; display: none; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f3f4f6; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 300px; text-align: center; }
        .login-box input { width: 90%; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .login-box button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: #ddd; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .tab.active { background: var(--primary); color: var(--white); }
        
        .sub-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .sub-tab { padding: 5px 15px; background: white; border: 1px solid #ccc; border-radius: 15px; cursor: pointer; font-size: 0.9rem; }
        .sub-tab.active { background: #374151; color: white; border-color: #374151; }

        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; } 
        
        .hidden-field { display: none !important; }

        label { font-size: 0.85rem; color: #555; margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        button.submit-btn { background: #10b981; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 20px; width: 100%; }
        
        .manage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .manage-list { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        .manage-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .manage-item:hover { background: #f9fafb; }
        
        .table-controls { display: flex; justify-content: space-between; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; }
        tr:hover { background: #f1f5f9; }
        
        .action-btn { padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer; color: white; margin-right: 5px; font-size: 0.8rem; }
        .btn-edit { background: var(--warning); color: black; }
        .btn-delete { background: var(--danger); }

        @media (max-width: 600px) { 
            .table-controls { flex-direction: column; gap: 10px; } 
            .manage-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>System Login</h2>
        <input type="text" id="username" placeholder="Username (admin/staff)">
        <input type="password" id="password" placeholder="Password">
        <button onclick="attemptLogin()">Login</button>
        <p id="login-error" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
    </div>
</div>

<div class="container" id="app-container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Logistics Management</h2>
        <div style="text-align:right;">
             <button onclick="logout()" style="background:#eee; border:none; padding:5px 10px; cursor:pointer;">Logout</button>
             <button onclick="forceRefreshData()" style="background:#eee; border:none; padding:5px 10px; cursor:pointer; font-size:0.8rem;">⚠️ Force Sync</button>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="setMode('PURCHASE')">PURCHASE</button>
        <button class="tab" onclick="setMode('SALES')">SALES</button>
        <button class="tab" onclick="setMode('PURCHASE_RET')">PURCHASE RETURN</button>
        <button class="tab" onclick="setMode('SALES_RET')">SALES RETURN</button>
        <button class="tab" style="background:#374151; color:white;" onclick="setMode('MANAGE')">MANAGE DATA</button>
    </div>

    <div class="card" id="log-entry-card">
        <h3 id="form-title">New Entry</h3>
        <p id="edit-notice" style="display:none; color: var(--warning); font-size: 0.9rem;">⚠️ You are editing an existing record. <button type="button" onclick="cancelEdit()" style="text-decoration:underline; border:none; background:none; cursor:pointer; color:blue;">Cancel</button></p>
        
        <form id="logForm" onsubmit="submitData(event)">
            <div class="form-grid" id="dynamic-fields"></div>
            <button type="submit" class="submit-btn" id="save-btn">Save Entry</button>
        </form>
    </div>

    <div class="card" id="manage-ui-card" style="display:none;">
        <h3>Manage Database</h3>
        
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="setManageType('CUSTOMER')">Customers</button>
            <button class="sub-tab" onclick="setManageType('SELLER')">Sellers</button>
            <button class="sub-tab" id="tab-emp" onclick="setManageType('EMPLOYEE')">Employees</button>
        </div>

        <div class="manage-grid">
            <div style="background:#f9fafb; padding:15px; border-radius:8px;">
                <h4 style="margin-top:0;">Add New <span id="manage-type-label">Customer</span></h4>
                <form onsubmit="submitManageData(event)">
                    <input type="text" id="new-name" placeholder="Name" onkeyup="renderManageList(this.value)" required>
                    <input type="text" id="new-location" placeholder="Location" required>
                    <button type="submit" class="submit-btn" style="margin-top:10px;">Add to Database</button>
                </form>
            </div>

            <div>
                <input type="text" id="manage-search" placeholder="Search..." onkeyup="renderManageList()">
                <div class="manage-list" id="manage-list-container"></div>
            </div>
        </div>
    </div>

    <div class="card" id="table-card">
        <div class="table-controls">
            <h3>Recent Logs</h3>
            <input type="text" id="searchInput" placeholder="Search Bill No, Firm, Name..." onkeyup="renderTable()">
        </div>
        <div style="overflow-x:auto;">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Firm</th>
                        <th>Party/Brand</th>
                        <th>Bill No</th>
                        <th>Pcs</th>
                        <th>Amt</th>
                        <th id="actions-header" style="display:none;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, deleteDoc, updateDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBBszqQlych7F1g82TA37y6Bvhj6EwFfdg",
        authDomain: "logistics-app-mona-rnc.firebaseapp.com",
        projectId: "logistics-app-mona-rnc",
        storageBucket: "logistics-app-mona-rnc.firebasestorage.app",
        messagingSenderId: "989428986519",
        appId: "1:989428986519:web:cdcea9bd1b6aecdb9d2fd2",
        measurementId: "G-LSP2HCVPKC"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- STATE ---
    let currentMode = "PURCHASE";
    let manageType = "CUSTOMER"; 
    let allLogs = [];
    let isAdmin = false;
    let editingId = null;
    let CUSTOMER_DB = [];
    let EMPLOYEE_DB = [];

    const DATA = {
        firms: ["Mona", "RNC"],
        brands: ["Jockey", "Amante", "Sweet Dreams"],
        deliveryTypes: ["Intra-city", "Inter-city"]
    };

    // --- QUOTA & ERROR HANDLING ---
    const handleFirebaseError = (error) => {
        console.error("Firebase Error:", error);
        if (error.code === 'resource-exhausted') {
            alert("⚠️ DAILY QUOTA EXCEEDED\n\nYou have used your 50,000 daily reads. The database will not save or delete until tomorrow. Do NOT clear cache.");
        } else {
            alert("Error: " + error.message);
        }
    };

    // --- DATABASE ACTIONS (Optimized) ---

    // 1. DELETE
    const deleteItem = async (id, type, btnElement) => {
        if (!confirm(`Are you sure you want to delete this ${type}?`)) return;
        
        const originalText = btnElement.innerText;
        btnElement.innerText = "...";
        btnElement.disabled = true;
        let collName = (type === 'EMPLOYEE') ? "employees" : "customers";

        try {
            await deleteDoc(doc(db, collName, id));
            
            // Local Update (Saves a Read)
            if (type === 'EMPLOYEE') {
                EMPLOYEE_DB = EMPLOYEE_DB.filter(item => item.id !== id);
                localStorage.setItem('employee_db', JSON.stringify(EMPLOYEE_DB));
            } else {
                CUSTOMER_DB = CUSTOMER_DB.filter(item => item.id !== id);
                localStorage.setItem('customer_db', JSON.stringify(CUSTOMER_DB));
            }
            renderManageList(); 
            alert("Deleted Successfully");
        } catch (error) {
            handleFirebaseError(error);
            btnElement.innerText = originalText;
            btnElement.disabled = false;
        }
    };

    // 2. ADD
    window.submitManageData = async (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('new-name');
        const locInput = document.getElementById('new-location');
        const name = nameInput.value.trim().toUpperCase();
        let collName = "customers"; 
        let data = { name: name };
        
        if (manageType === 'CUSTOMER') {
            data.location = locInput.value.trim().toUpperCase();
        } else if (manageType === 'SELLER') {
            data.location = "SUNDRY CREDITORS";
        } else if (manageType === 'EMPLOYEE') {
            collName = "employees";
        }
        
        const id = name.replace(/[^a-zA-Z0-9]/g, "_").toLowerCase() + "_" + Math.floor(Math.random() * 1000);
        
        try {
            await setDoc(doc(db, collName, id), data);
            
            // Local Update (Saves a Read)
            const newItem = { id: id, ...data };
            if (manageType === 'EMPLOYEE') {
                EMPLOYEE_DB.push(newItem);
                localStorage.setItem('employee_db', JSON.stringify(EMPLOYEE_DB));
            } else {
                CUSTOMER_DB.push(newItem);
                localStorage.setItem('customer_db', JSON.stringify(CUSTOMER_DB));
            }
            alert(`${manageType} Added Successfully!`);
            nameInput.value = '';
            locInput.value = '';
            renderManageList(); 
        } catch (error) { handleFirebaseError(error); }
    };

    // --- DATA LOADING (Quota Optimized) ---
    async function loadAllData() {
        await Promise.all([loadCustomers(), loadEmployees()]);
    }
    
    // Only fetch if cache is EMPTY or User Force Syncs
    window.forceRefreshData = () => {
        if(confirm("Warning: This uses significant database quota. Only use if data is missing. Continue?")) {
            localStorage.removeItem('customer_db');
            localStorage.removeItem('employee_db');
            // Small delay ensures storage is cleared before reload
            setTimeout(() => {
                location.reload();
            }, 100);
        }
    }

    async function loadCustomers() {
        const cached = localStorage.getItem('customer_db');
        if (cached && cached !== "[]") {
            // USE CACHE
            console.log("Using Cached Customers (Saves Reads)");
            CUSTOMER_DB = JSON.parse(cached);
        } else {
            // DOWNLOAD (Costly)
            console.log("Downloading Customers...");
            try {
                const q = query(collection(db, "customers"));
                const snap = await getDocs(q);
                CUSTOMER_DB = [];
                snap.forEach(doc => CUSTOMER_DB.push({ id: doc.id, ...doc.data() }));
                localStorage.setItem('customer_db', JSON.stringify(CUSTOMER_DB));
            } catch(e) { handleFirebaseError(e); }
        }
    }

    async function loadEmployees() {
        const cached = localStorage.getItem('employee_db');
        if (cached && cached !== "[]") {
            console.log("Using Cached Employees");
            EMPLOYEE_DB = JSON.parse(cached);
        } else {
            console.log("Downloading Employees...");
            try {
                const q = query(collection(db, "employees"));
                const snap = await getDocs(q);
                EMPLOYEE_DB = [];
                snap.forEach(doc => EMPLOYEE_DB.push({ id: doc.id, ...doc.data() }));
                localStorage.setItem('employee_db', JSON.stringify(EMPLOYEE_DB));
            } catch(e) { handleFirebaseError(e); }
        }
    }

    // --- AUTH ---
    window.attemptLogin = async () => {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        if ((u === "admin" && p === "admin") || (u === "staff" && p === "123")) {
            isAdmin = (u === "admin");
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('actions-header').style.display = 'table-cell';
            if(!isAdmin) document.getElementById('tab-emp').style.display = 'none';
            await loadAllData();
            renderForm();
            fetchData();
        } else {
            document.getElementById('login-error').innerText = "Invalid Creds";
        }
    };
    window.logout = () => location.reload();

    // --- UI RENDERING ---
    window.renderManageList = (overrideSearch) => {
        const container = document.getElementById('manage-list-container');
        let search = (typeof overrideSearch === 'string') ? overrideSearch : document.getElementById('manage-search').value;
        search = search.toLowerCase();
        container.innerHTML = '';

        let list = [];
        if (manageType === 'CUSTOMER') {
            list = CUSTOMER_DB.filter(c => c.location !== "Sundry Creditors");
        } else if (manageType === 'SELLER') {
            list = CUSTOMER_DB.filter(c => c.location === "Sundry Creditors");
        } else if (manageType === 'EMPLOYEE') {
            list = EMPLOYEE_DB;
        }

        list = list.filter(item => item.name.toLowerCase().includes(search));
        list.sort((a, b) => a.name.localeCompare(b.name));

        list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'manage-item';
            
            const infoDiv = document.createElement('div');
            let infoHtml = `<strong>${item.name}</strong>`;
            if (manageType === 'CUSTOMER') infoHtml += ` <small>(${item.location})</small>`;
            infoDiv.innerHTML = infoHtml;

            const actionDiv = document.createElement('div');
            if (isAdmin) {
                const btn = document.createElement('button');
                btn.className = 'action-btn btn-delete';
                btn.innerText = 'Del';
                btn.onclick = () => deleteItem(item.id, manageType, btn);
                actionDiv.appendChild(btn);
            }
            div.appendChild(infoDiv);
            div.appendChild(actionDiv);
            container.appendChild(div);
        });
    };

    // --- TABLE & FORMS ---
    window.renderTable = () => {
        const tbody = document.querySelector('#dataTable tbody');
        const search = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';
        const filtered = allLogs.filter(log => Object.values(log).join(' ').toLowerCase().includes(search));
        
        filtered.forEach(log => {
            const tr = document.createElement('tr');
            const date = log.date_bill || log.date_lr || log.date_main || "N/A";
            const party = log.party || log.brand || "-";
            
            tr.innerHTML = `<td>${date}</td><td><span style="font-size:0.8em; padding:2px 5px; background:#e5e7eb;">${log.type}</span></td><td>${log.firm}</td><td>${party}</td><td>${log.bill_no || log.against_bill || '-'}</td><td>${log.pcs || '-'}</td><td>${log.amount || '-'}</td>`;

            const actionTd = document.createElement('td');
            const editBtn = document.createElement('button');
            editBtn.className = "action-btn btn-edit";
            editBtn.innerText = "Edit";
            editBtn.onclick = () => window.startEdit(log.id);
            actionTd.appendChild(editBtn);

            if (isAdmin) {
                const delBtn = document.createElement('button');
                delBtn.className = "action-btn btn-delete";
                delBtn.innerText = "Del";
                delBtn.style.marginLeft = "5px";
                delBtn.onclick = () => deleteItemLog(log.id, delBtn);
                actionTd.appendChild(delBtn);
            }
            if(isAdmin || true) tr.appendChild(actionTd);
            tbody.appendChild(tr);
        });
    };

    const deleteItemLog = async (id, btnElement) => { 
        if(!confirm("Delete Log?")) return;
        btnElement.innerText = "...";
        try {
            await deleteDoc(doc(db, "logs", id)); 
            fetchData(); 
        } catch(e) { handleFirebaseError(e); btnElement.innerText = "Del"; }
    };

    window.submitData = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('save-btn');
        btn.innerText = "Saving...";
        btn.disabled = true;
        const formData = new FormData(e.target);
        const data = { type: currentMode, timestamp: new Date() };
        if (editingId && !isAdmin) {
             const oldLog = allLogs.find(l => l.id === editingId);
             Object.assign(data, oldLog); 
             delete data.id; 
        }
        formData.forEach((value, key) => data[key] = value);
        try {
            if (editingId) {
                await updateDoc(doc(db, "logs", editingId), data);
                alert("Updated!");
                cancelEdit();
            } else {
                await addDoc(collection(db, "logs"), data);
                alert("Saved!");
                e.target.reset();
                renderForm(); 
            }
            fetchData(); 
        } catch (error) { handleFirebaseError(error); }
        btn.innerText = "Save Entry";
        btn.disabled = false;
    };

    async function fetchData() {
        const q = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(50));
        try {
            const snap = await getDocs(q);
            allLogs = [];
            snap.forEach((doc) => allLogs.push({ id: doc.id, ...doc.data() }));
            renderTable();
        } catch(e) { handleFirebaseError(e); }
    }

    // --- FORM LOGIC (Unchanged) ---
    window.setMode = (mode) => {
        currentMode = mode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        if (mode === 'MANAGE') {
            document.getElementById('log-entry-card').style.display = 'none';
            document.getElementById('table-card').style.display = 'none';
            document.getElementById('manage-ui-card').style.display = 'block';
            setManageType('CUSTOMER'); 
        } else {
            if(editingId) cancelEdit();
            document.getElementById('log-entry-card').style.display = 'block';
            document.getElementById('table-card').style.display = 'block';
            document.getElementById('manage-ui-card').style.display = 'none';
            document.getElementById('form-title').innerText = `New ${mode.replace('_', ' ')} Entry`;
            renderForm();
        }
    };

    window.setManageType = (type) => {
        manageType = type;
        document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
        const tabs = Array.from(document.querySelectorAll('.sub-tab'));
        const activeTab = tabs.find(t => t.innerText.toUpperCase().startsWith(type) || (type === 'SELLER' && t.innerText === 'Sellers'));
        if(activeTab) activeTab.classList.add('active');
        const label = type.charAt(0) + type.slice(1).toLowerCase();
        document.getElementById('manage-type-label').innerText = label;
        document.getElementById('new-name').value = '';
        const loc = document.getElementById('new-location');
        loc.value = '';
        if (type === 'CUSTOMER') {
            loc.style.display = 'block';
            loc.required = true;
        } else {
            loc.style.display = 'none';
            loc.required = false;
        }
        renderManageList();
    };

    window.startEdit = (id) => {
        const log = allLogs.find(l => l.id === id);
        if (!log) return;
        setMode(log.type);
        editingId = id; 
        renderForm(log);
        document.getElementById('edit-notice').style.display = 'block';
        document.getElementById('save-btn').innerText = isAdmin ? "Update Entry" : "Update Delivery Info"; 
        document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
    };

    window.cancelEdit = () => {
        editingId = null;
        document.getElementById('edit-notice').style.display = 'none';
        document.getElementById('save-btn').innerText = "Save Entry";
        document.getElementById('logForm').reset();
        renderForm(); 
    };

    const FORMS = {
        PURCHASE: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "L/R Date", type: "date", key: "date_lr" },
            { label: "L/R No.", type: "text", key: "L/R_no" },
            { label: "Bill Date", type: "date", key: "date_bill" },
            { label: "Bill No.", type: "text", key: "bill_no" },
            { label: "Date Recd", type: "date", key: "date_recd" },
            { label: "Seller Name", type: "text", key: "party", list: "purchase_sellers" },
            { label: "Cartons", type: "number", key: "cartons" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Recd By", type: "text", key: "recd_by", list: "employees" },
            { label: "Checked By", type: "text", key: "checked_by", list: "employees" },
            { label: "Remark", type: "text", key: "remark" }
        ],
        SALES: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "Bill Date", type: "date", key: "date_bill" },
            { label: "Delivery Date", type: "date", key: "date_deliv" },
            { label: "Location (Filter)", type: "text", key: "location_filter", list: "locations" },
            { label: "Purchaser/Cust", type: "text", key: "party", list: "customers" },
            { label: "Brand", type: "select", options: DATA.brands, key: "brand" },
            { label: "Bill No", type: "text", key: "bill_no" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Delivery Type", type: "select", options: DATA.deliveryTypes, key: "delivery_type" },
            { label: "L/R No.", type: "text", key: "lr_no", group: "intra" },
            { label: "Transport Mode", type: "text", key: "transport_mode", group: "intra" },
            { label: "Signed Copy Recvd?", type: "select", options: ["No", "Yes"], key: "signed_copy", group: "inter" },
            { label: "Deliv Person", type: "text", key: "deliv_by", list: "employees" },
            { label: "Bill Made By", type: "text", key: "made_by", list: "employees" },
            { label: "Checked By", type: "text", key: "checked_by", list: "employees" },
            { label: "Remark", type: "text", key: "remark" }
        ],
        PURCHASE_RET: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "Return Date", type: "date", key: "date_main" },
            { label: "Target Brand", type: "select", options: DATA.brands, key: "party" },
            { label: "Against Bill No", type: "text", key: "against_bill" },
            { label: "Credit note No", type: "text", key: "credit_note_no" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Sent By (Remark)", type: "text", key: "remark" }
        ],
        SALES_RET: [
            { label: "Firm", type: "select", options: DATA.firms, key: "firm" },
            { label: "Return Date", type: "date", key: "date_main" },
            { label: "Customer", type: "text", key: "party", list: "customers" }, 
            { label: "Brand", type: "select", options: DATA.brands, key: "brand" },
            { label: "Against Bill No", type: "text", key: "against_bill" },
            { label: "Pieces", type: "number", key: "pcs" },
            { label: "Amount", type: "number", key: "amount" },
            { label: "Sent By (Remark)", type: "text", key: "remark" },
            { label: "Recvd By", type: "text", key: "Recvd_by", list: "employees" },
            { label: "Approved By", type: "text", key: "approved_by", list: "employees" },
            { label: "Transport recieved", type: "text", key: "transport"},
            { label: "L/R No.", type: "text", key: "L/R_no" }
        ]
    };

    window.renderForm = (dataToFill = null) => {
        const container = document.getElementById('dynamic-fields');
        container.innerHTML = '';
        const isStaffEdit = (editingId !== null && !isAdmin);
        const staffAllowedFields = ['lr_no', 'transport_mode', 'remark', 'L/R_no', 'transport', 'signed_copy', 'delivery_type'];
        
        const dlContainer = document.createElement('div');
        dlContainer.style.display = 'none';

        const uniqueLocs = [...new Set(CUSTOMER_DB.map(c => c.location))].sort();
        const locDL = document.createElement('datalist');
        locDL.id = "dl-locations";
        uniqueLocs.forEach(l => { const o = document.createElement('option'); o.value = l; locDL.appendChild(o); });
        dlContainer.appendChild(locDL);

        const custDL = document.createElement('datalist');
        custDL.id = "dl-customers";
        CUSTOMER_DB.filter(c => c.location !== "Sundry Creditors").forEach(c => { const o = document.createElement('option'); o.value = c.name; custDL.appendChild(o); });
        dlContainer.appendChild(custDL);

        const sundrySellers = CUSTOMER_DB.filter(c => c.location === "Sundry Creditors").map(c => c.name);
        const allSellers = [...new Set(["Milton", "Apna Bazaar", "Karachu", ...sundrySellers])].sort();
        const sellerDL = document.createElement('datalist');
        sellerDL.id = "dl-purchase_sellers";
        allSellers.forEach(n => { const o = document.createElement('option'); o.value = n; sellerDL.appendChild(o); });
        dlContainer.appendChild(sellerDL);

        const empDL = document.createElement('datalist');
        empDL.id = "dl-employees";
        EMPLOYEE_DB.forEach(e => { const o = document.createElement('option'); o.value = e.name; empDL.appendChild(o); });
        dlContainer.appendChild(empDL);
        container.appendChild(dlContainer);

        FORMS[currentMode].forEach(field => {
            const group = document.createElement('div');
            group.className = 'form-group';
            if (field.group) group.classList.add(`group-${field.group}`);
            const label = document.createElement('label');
            label.innerText = field.label;
            group.appendChild(label);
            let input;
            if (field.type === 'select') {
                input = document.createElement('select');
                field.options.forEach(opt => { const option = document.createElement('option'); option.value = opt; option.innerText = opt; input.appendChild(option); });
            } else {
                input = document.createElement('input');
                input.type = field.type;
                if(field.type === 'number') input.step = "0.01";
                if (field.list) input.setAttribute('list', `dl-${field.list}`);
                if (field.key === 'location_filter') {
                    input.oninput = (e) => {
                        const loc = e.target.value.toLowerCase();
                        const targetList = document.getElementById('dl-customers');
                        targetList.innerHTML = '';
                        CUSTOMER_DB.filter(c => c.location.toLowerCase().includes(loc) && c.location !== "Sundry Creditors").forEach(c => { const o = document.createElement('option'); o.value = c.name; targetList.appendChild(o); });
                    };
                }
                if (field.key === 'party' && currentMode === 'SALES') {
                    input.onchange = (e) => {
                         const match = CUSTOMER_DB.find(c => c.name === e.target.value);
                         const locInput = document.querySelector('input[name="location_filter"]');
                         if(match && locInput) locInput.value = match.location;
                    };
                }
            }
            input.name = field.key;
            if (field.key === 'delivery_type') input.onchange = updateVisibility;
            if(dataToFill && dataToFill[field.key]) input.value = dataToFill[field.key];
            if (isStaffEdit && !staffAllowedFields.includes(field.key)) { input.disabled = true; input.style.backgroundColor = "#e5e7eb"; }
            const optionalFields = ['remark', 'against_bill', 'credit_note_no', 'lr_no', 'transport_mode', 'L/R_no', 'transport', 'signed_copy', 'location_filter'];
            if (!optionalFields.includes(field.key)) input.required = true;
            if(field.type === 'date' && !dataToFill) input.valueAsDate = new Date();
            group.appendChild(input);
            container.appendChild(group);
        });
        if (currentMode === 'SALES') updateVisibility();
    };

    window.updateVisibility = () => {
        if (currentMode !== 'SALES') return;
        const typeSelect = document.querySelector('select[name="delivery_type"]');
        if (!typeSelect) return;
        const type = typeSelect.value;
        document.querySelectorAll('.group-intra').forEach(el => el.classList.toggle('hidden-field', type !== 'Intra-city'));
        document.querySelectorAll('.group-inter').forEach(el => el.classList.toggle('hidden-field', type !== 'Inter-city'));
    };
    window.deleteItem = deleteItem;
    window.deleteItemLog = deleteItemLog;
    window.attemptLogin = attemptLogin;
    window.forceRefreshData = forceRefreshData;
</script>
</body>
</html>
